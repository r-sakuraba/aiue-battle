<html>
  <body>
    <h1>room:<span id="room"></span></h1>
    <h2>プレイヤー名:<span id="name"></span></h2>

    <h2>部屋にいる人:</h2>
    <ul id="memberList"></ul>

    <button id="startButton">開始</button>

    <h2>あなたの情報</h2>
    <ul id="myInfoList"></ul>

    <h2>情報</h2>
    <ul id="infoList"></ul>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const url = new URL(window.location.href);
      let userName = url.searchParams.get('name');
      let roomName = url.searchParams.get('room');
      let _id2Name = {};

      document.getElementById('name').textContent = userName;
      document.getElementById('room').textContent = roomName;

      socket.on('connect', () => {
        console.log('connect');
        socket.emit('joinRoom', {
          roomName,
          userName,
        });
      });

      socket.on('changeId2Name', (id2Name) => {
        console.log(id2Name);
        _id2Name = id2Name;

        const ul = document.getElementById('memberList');
        ul.innerHTML = '';

        Object.values(_id2Name).forEach((member) => {
          if (member === userName) {
            return;
          }
          const li = document.createElement('li');
          const text = document.createTextNode(member);
          li.appendChild(text);
          ul.appendChild(li);
        });
      });

      socket.on('memberList', (memberList) => {
        const ul = document.getElementById('memberList');
        ul.innerHTML = '';

        memberList.forEach((member) => {
          if (member === userName) {
            return;
          }
          const li = document.createElement('li');
          const text = document.createTextNode(member);
          li.appendChild(text);
          ul.appendChild(li);
        });
      });

      getVisibleText = (answerInfo) => {
        let text = '';
        answerInfo.visible.forEach((visible, i) => {
          text += visible ? answerInfo[i] : '*';
        });
        return text;
      };

      document.getElementById('startButton').addEventListener('click', () => {
        answer = window.prompt('あなたの答えを入力してください', '');
        socket.emit('readyGame', answer);
      });

      socket.on('startGame', (gameInfo) => {
        console.log('startGame');
        console.log(gameInfo);

        const myUl = document.getElementById('myInfoList');
        myUl.innerHTML = '';
        const myAnsewerText = document.createTextNode('答え:' + gameInfo[socket.id].answer);
        ul.appendChild(document.createElement('li').appendChild(myAnsewerText));
        const myVisibleText = document.createTextNode('相手に見えている状態:' + getVisibleText(gameInfo[socket.id]));
        ul.appendChild(document.createElement('li').appendChild(myVisibleText));

        const ul = document.getElementById('infoList');
        Object.keys(gameInfo).forEach((socketId) => {
          const li = document.createElement('li');
          const text = document.createTextNode(_id2Name[socketId] + ':' + getVisibleText(gameInfo[socketId]));
          li.appendChild(text);
          ul.appendChild(li);
        });
      });
    </script>
  </body>
</html>
